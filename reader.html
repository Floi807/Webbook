<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Чтение книги</title>
  <script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; background: #f3f6f8; }
    #viewer {
      width: 100%;
      height: 100vh;
      border: none;
    }
    #error {
      padding: 20px;
      color: #900;
      font-size: 18px;
    }
  </style>
</head>
<body>

<div id="viewer"></div>
<div id="error" style="display:none;"></div>

<script>
  function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  }

  (async function(){
    const fileParam = getQueryParam('file');
    const errorEl = document.getElementById('error');
    if (!fileParam) {
      errorEl.style.display = 'block';
      errorEl.textContent = 'Ошибка: параметр file не задан в URL.';
      return;
    }

    // Кодируем части пути
    const safePath = fileParam.split('/').map(encodeURIComponent).join('/');
    const fullPath = safePath;

    try {
      const resp = await fetch(fullPath, { method: 'HEAD' });
      if (!resp.ok) {
        throw new Error('Файл не найден. Проверьте путь: ' + fullPath);
      }
    } catch (e) {
      errorEl.style.display = 'block';
      errorEl.textContent = 'Ошибка: ' + e.message;
      console.error(e);
      return;
    }

    try {
      const book = ePub(fullPath);
      const rendition = book.renderTo("viewer", { width: "100%", height: "100%" });
      await rendition.display();
    } catch (e) {
      errorEl.style.display = 'block';
      errorEl.textContent = 'Ошибка при отображении книги: ' + e.message;
      console.error(e);
    }
  })();
</script>

</body>
</html>
